<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Session Publishing</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Test Session Publishing</h1>
    <p>This is a simple test form to debug session publishing.</p>
    
    <div id="message-container"></div>
    
    <form id="test-session-form">
        <div class="form-group">
            <label for="titreSession">Titre de la session</label>
            <input type="text" id="titreSession" name="titreSession" value="Test Session" required>
        </div>
        
        <div class="form-group">
            <label for="descriptionSession">Description</label>
            <textarea id="descriptionSession" name="descriptionSession" rows="3" required>This is a test session for debugging purposes.</textarea>
        </div>
        
        <div class="form-group">
            <label for="dateSession">Date</label>
            <input type="date" id="dateSession" name="dateSession" required>
        </div>
        
        <div class="form-group">
            <label for="heureSession">Heure</label>
            <input type="time" id="heureSession" name="heureSession" value="14:00" required>
        </div>
        
        <div class="form-group">
            <label for="tarifSession">Tarif (€)</label>
            <input type="number" id="tarifSession" name="tarifSession" value="25.00" min="0" step="0.01" required>
        </div>
        
        <div class="form-group">
            <label for="niveau">Niveau</label>
            <select id="niveau" name="niveau" required>
                <option value="">-- Sélectionnez --</option>
                <option value="Licence">Licence</option>
                <option value="Master">Master</option>
                <option value="Doctorat">Doctorat</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="typeSession">Type</label>
            <select id="typeSession" name="typeSession" required>
                <option value="en_ligne">En ligne</option>
                <option value="presentiel">Présentiel</option>
            </select>
        </div>
        
        <div class="form-group" id="meetingLinkGroup">
            <label for="lienReunion">Lien de réunion</label>
            <input type="url" id="lienReunion" name="lienReunion" value="https://meet.google.com/test-session">
        </div>
        
        <button type="submit">Publier la session</button>
    </form>

    <script>
        // Set tomorrow's date as default
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('dateSession').value = tomorrow.toISOString().split('T')[0];
        
        // Handle form submission
        document.getElementById('test-session-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageContainer = document.getElementById('message-container');
            const button = e.target.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = 'Publishing...';
            
            try {
                // First, get CSRF token
                const tokenResponse = await fetch('actions/get_csrf_token.php');
                const tokenData = await tokenResponse.json();
                
                if (!tokenData.csrf_token) {
                    throw new Error('Could not get CSRF token');
                }
                
                const formData = new FormData(e.target);
                formData.append('csrf_token', tokenData.csrf_token);
                
                console.log('Form data being sent:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                const response = await fetch('actions/publish_session.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    messageContainer.innerHTML = `<div class="message success">${result.message}</div>`;
                    e.target.reset();
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                messageContainer.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        });
        
        // Handle type change
        document.getElementById('typeSession').addEventListener('change', (e) => {
            const meetingGroup = document.getElementById('meetingLinkGroup');
            const lienInput = document.getElementById('lienReunion');
            
            if (e.target.value === 'en_ligne') {
                meetingGroup.style.display = 'block';
                lienInput.required = true;
            } else {
                meetingGroup.style.display = 'none';
                lienInput.required = false;
                lienInput.value = '';
            }
        });
    </script>
</body>
</html>
